(()=>{"use strict";(()=>{const e="Enter",t="Escape",i=(e,t)=>(e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e+1))+e);window.util={getRandomInt:i,getRandomFromArray:e=>e[i(0,e.length-1)],getShuffledArray:e=>e.slice().sort((()=>.5-Math.random())),onEscPress:(e,i)=>{e.key===t&&(e.preventDefault(),i())},onEnterPress:(t,i)=>{t.key===e&&i(t)},debounce:e=>{let t=null;return(...i)=>{t&&window.clearTimeout(t),t=window.setTimeout((function(){e(...i)}),500)}}}})(),(()=>{const e=/^\d+/,t=document.querySelector(".big-picture"),i=t.querySelector(".social__comments"),n=t.querySelector(".social__comments-loader"),o=t.querySelector(".social__comment-count"),s=()=>{const t=i.querySelectorAll(".hidden"),s=parseInt(o.innerHTML.match(e)[0],10);if(t.length){const i=t.length<5?t.length:5;for(let e=0;e<i;e++)t[e].classList.remove("hidden");i<5&&n.classList.add("hidden"),o.innerHTML=o.innerHTML.replace(e,s+i)}},r=r=>{const d=t.querySelector(".big-picture__img img"),u=t.querySelector(".likes-count"),f=t.querySelector(".comments-count"),m=t.querySelector(".social__caption"),w=t.querySelector(".big-picture__cancel");d.src=r.url,u.textContent=r.likes,f.textContent=r.comments.length,m.textContent=r.description,(r=>{const c=i.querySelector(".social__comment");let l=document.createDocumentFragment();if(r.forEach(((e,t)=>{const i=c.cloneNode(!0),n=i.querySelector(".social__picture"),o=i.querySelector(".social__text");n.src=e.avatar,n.alt=e.name,o.textContent=e.message,t>=5&&i.classList.add("hidden"),l.appendChild(i)})),r.length<5){const i=t.querySelector(".comments-count").textContent;o.innerHTML=o.innerHTML.replace(e,i),n.classList.add("hidden")}else o.innerHTML=o.innerHTML.replace(e,5),n.classList.remove("hidden");n.addEventListener("click",s),n.addEventListener("keydown",a),i.innerHTML="",i.appendChild(l)})(r.comments),document.body.classList.add("modal-open"),t.classList.remove("hidden"),document.addEventListener("keydown",l),w.addEventListener("click",c)},c=()=>{t.classList.add("hidden"),document.body.classList.remove("modal-open")},l=e=>{window.util.onEscPress(e,c)},a=e=>{window.util.onEnterPress(e,s)};window.picture={showPreview:(e,t)=>{const i=document.querySelector(".pictures").querySelectorAll(".picture");for(let n=0;n<=i.length;n++)if(i[n]===e){r(t[n]);break}}}})(),(()=>{const e="https://21.javascript.pages.academy/kekstagram",t="https://21.javascript.pages.academy/kekstagram/data",i=(e,t,i,n)=>{let o=new XMLHttpRequest;return o.responseType="json",o.addEventListener("load",(()=>{switch(o.status){case 200:i(o.response);break;default:n(`Статус ответа: ${o.status} - ${o.statusText}`)}})),o.addEventListener("error",(()=>{n("Ошибка соединения")})),o.addEventListener("timeout",(()=>{n(`Таймаут: ${o.timeout} мс.`)})),o.timeout=1e4,o.open(e,t),o};window.backend={load:(e,n)=>{i("GET",t,e,n).send()},save:(t,n,o)=>{i("POST",e,n,o).send(t)}}})(),(()=>{const e=document.querySelector(".pictures"),t=document.querySelector("#picture").content.querySelector(".picture"),i=e=>{e.preventDefault(),"picture"===e.target.className&&window.picture.showPreview(e.target,window.thumbnails.filteredPhotos?window.thumbnails.filteredPhotos:window.thumbnails.initialPhotos)};e.addEventListener("click",(function(e){"picture__img"===e.target.className&&window.picture.showPreview(e.target.parentNode,window.thumbnails.filteredPhotos?window.thumbnails.filteredPhotos:window.thumbnails.initialPhotos)})),e.addEventListener("keydown",(function(e){window.util.onEnterPress(e,i)})),window.thumbnails={initialPhotos:void 0,filteredPhotos:void 0,renderPhotos:i=>{const n=e.querySelectorAll(".picture");let o=document.createDocumentFragment();n&&n.forEach((e=>{e.parentNode.removeChild(e)})),i.forEach((e=>{o.appendChild((e=>{const i=t.cloneNode(!0),n=i.querySelector(".picture__img"),o=i.querySelector(".picture__comments"),s=i.querySelector(".picture__likes");return n.src=e.url,s.textContent=e.likes,o.textContent=e.comments.length,i})(e))})),e.appendChild(o)}}})(),window.popup={renderPopup:(e,t,i)=>{const n=document.querySelector("#"+e).content.querySelector("."+e),o=document.querySelector("main"),s=n.cloneNode(!0),r={title:s.querySelector(`.${e}__title`),button:s.querySelector(`.${e}__button`)};t&&(r.title.textContent=t),i&&(r.button.textContent=i);const c=e=>{window.util.onEscPress(e,l)},l=t=>{if(t&&"error"===e){if(t.preventDefault(),t.target.className!==""+e&&t.target.className!==e+"__button")return;o.removeChild(s)}else o.removeChild(s);document.removeEventListener("click",l),document.removeEventListener("keydown",c)};o.appendChild(s),r.button.focus(),r.button.addEventListener("keydown",(function(e){window.util.onEnterPress(e,l)})),document.addEventListener("keydown",c),document.addEventListener("click",l)}},window.backend.load((e=>{window.thumbnails.initialPhotos=e,window.thumbnails.renderPhotos(e),window.filter.show()}),(e=>{window.popup.renderPopup("error",e,"Закрыть")})),(()=>{const e=document.querySelector(".img-filters__form"),t=window.util.debounce((t=>{window.thumbnails.filteredPhotos=(t=>{const i=e.querySelector(".img-filters__button--active"),n=e.querySelector("#"+t);switch(i.classList.remove("img-filters__button--active"),n.classList.add("img-filters__button--active"),t){case"filter-random":return window.util.getShuffledArray(window.thumbnails.initialPhotos).slice(0,10);case"filter-discussed":return window.thumbnails.initialPhotos.slice().sort((function(e,t){return t.comments.length-e.comments.length}));default:return window.thumbnails.initialPhotos}})(t.target.id),window.thumbnails.renderPhotos(window.thumbnails.filteredPhotos)}));window.filter={show:()=>{e.parentElement.classList.remove("img-filters--inactive"),e.addEventListener("click",(function(e){t(e)}))}}})(),(()=>{const e=document.querySelector(".img-upload"),t=/(\d+)/,i={imgUploadPreview:e.querySelector(".img-upload__preview img"),effectSlider:e.querySelector(".img-upload__effect-level"),effectLevelPin:e.querySelector(".effect-level__pin"),effectLevelLine:e.querySelector(".effect-level__line"),effectLevelDepth:e.querySelector(".effect-level__depth"),effectLevelValue:e.querySelector(".effect-level__value"),scaleValue:e.querySelector(".scale__control--value")},n=()=>{const e=(()=>{const e=i.effectLevelLine.clientWidth;return i.effectLevelDepth.clientWidth/e})(),t=100*e.toFixed(2),n=e.toFixed(1),o=100*e.toFixed(2)*.03,s=100*e.toFixed(2)*.02+1;switch(!0){case i.imgUploadPreview.classList.contains("effects__preview--chrome"):i.imgUploadPreview.style.filter=`grayscale(${n})`;break;case i.imgUploadPreview.classList.contains("effects__preview--sepia"):i.imgUploadPreview.style.filter=`sepia(${n})`;break;case i.imgUploadPreview.classList.contains("effects__preview--marvin"):i.imgUploadPreview.style.filter=`invert(${t}%)`;break;case i.imgUploadPreview.classList.contains("effects__preview--phobos"):i.imgUploadPreview.style.filter=`blur(${o}px)`;break;case i.imgUploadPreview.classList.contains("effects__preview--heat"):i.imgUploadPreview.style.filter=`brightness(${s})`;break;default:i.imgUploadPreview.style.filter=""}i.effectLevelValue.value=t},o=()=>{i.imgUploadPreview.className="",i.imgUploadPreview.style.filter=""};window.effects={form:i,onEffectsChange:e=>{(e=>{switch(!0){case e.matches("#effect-chrome"):o(),i.effectSlider.classList.remove("hidden"),i.imgUploadPreview.classList.add("effects__preview--chrome");break;case e.matches("#effect-sepia"):o(),i.effectSlider.classList.remove("hidden"),i.imgUploadPreview.classList.add("effects__preview--sepia");break;case e.matches("#effect-marvin"):o(),i.effectSlider.classList.remove("hidden"),i.imgUploadPreview.classList.add("effects__preview--marvin");break;case e.matches("#effect-phobos"):o(),i.effectSlider.classList.remove("hidden"),i.imgUploadPreview.classList.add("effects__preview--phobos");break;case e.matches("#effect-heat"):o(),i.effectSlider.classList.remove("hidden"),i.imgUploadPreview.classList.add("effects__preview--heat");break;default:o(),i.effectSlider.classList.add("hidden"),i.effectLevelValue.value=""}i.effectLevelPin.addEventListener("mouseup",n)})(e.target),(()=>{const e=i.effectLevelLine.clientWidth;i.effectLevelPin.style.left=e+"px",i.effectLevelDepth.style.width=e+"px",i.effectLevelValue.value="100"})(),n()},onSetEffectIntencity:n,setScaleFactor:e=>{let n=parseInt(i.scaleValue.value.match(t)[0],10);if(e)switch(!0){case e.target.classList.contains("scale__control--bigger"):n+=25;break;case e.target.classList.contains("scale__control--smaller"):n-=25}else n=100;n>100?n=100:n<25&&(n=25),i.scaleValue.value=n+" %",i.imgUploadPreview.style.transform=`scale(${n/100})`},resetEffect:o}})(),window.effects.form.effectLevelPin.addEventListener("mousedown",(e=>{e.preventDefault();const t=window.effects.form.effectLevelLine.clientWidth;let i={x:e.clientX},n=!1;const o=e=>{e.preventDefault(),n=!0;let o=i.x-e.clientX;i={x:e.clientX};const s=window.effects.form.effectLevelPin.offsetLeft-o;s>=0&&(0===s?(window.effects.form.effectLevelPin.style.left="0",window.effects.form.effectLevelDepth.style.width="0"):s<=t&&(window.effects.form.effectLevelPin.style.left=s+"px",window.effects.form.effectLevelDepth.style.width=s+"px"),window.effects.onSetEffectIntencity(e))},s=e=>{if(e.preventDefault(),document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",s),n){const e=t=>{t.preventDefault(),window.effects.form.effectLevelPin.removeEventListener("click",e)};window.effects.form.effectLevelPin.addEventListener("click",e)}};document.addEventListener("mousemove",o),document.addEventListener("mouseup",s)})),(()=>{const e=/^#[a-zA-Zа-яА-Я|\d]+$/,t=document.querySelector(".img-upload").querySelector(".text__hashtags");window.validate={checkHashtags:()=>{if(t.value){const n=t.value.trim().toLowerCase().split(" ");n.length>5?t.setCustomValidity("Количество хэштэгов не должно превышать 5"):(i=n,new Set(i).size!==i.length?t.setCustomValidity("Хэштэги не должны повторяться"):n.forEach((i=>{1===i.length?t.setCustomValidity(`Длина хэштэга "${i}" не должна быть меньше 1`):i.length>20?t.setCustomValidity(`Длина хэштэга "${i}" не должна быть больше 20`):e.test(i)||t.setCustomValidity(`Хэштэг "${i}" не соответствует правилам оформления`)})))}else t.setCustomValidity("");var i;t.reportValidity()},clearHashtagValidity:()=>{t.setCustomValidity(""),t.reportValidity(),t.classList.remove("text--errors")}}})(),(()=>{const e=document.querySelector("#upload-file"),t=document.querySelector(".img-upload__overlay"),i=document.querySelector("#upload-cancel"),n=document.querySelector(".img-upload").querySelector(".img-upload__form"),o={hashtags:n.querySelector(".text__hashtags"),description:n.querySelector(".text__description"),effects:n.querySelector(".img-upload__effects"),scaleButtons:n.querySelectorAll(".img-upload__scale button"),submitButton:n.querySelector(".img-upload__submit")},s=e=>{document.activeElement!==o.hashtags&&document.activeElement!==o.description&&window.util.onEscPress(e,r)},r=()=>{t.classList.add("hidden"),document.body.classList.remove("modal-open"),e.value="",o.effects.removeEventListener("change",window.effects.onEffectsChange),o.hashtags.removeEventListener("input",c),document.removeEventListener("keydown",s),o.scaleButtons.forEach((e=>{e.removeEventListener("click",l)})),n.removeEventListener("submit",a)},c=()=>window.validate.clearHashtagValidity(),l=e=>window.effects.setScaleFactor(e),a=e=>{e.preventDefault(),window.validate.checkHashtags(),o.hashtags.validity.valid?window.backend.save(new FormData(n),d,u):o.hashtags.classList.add("text--errors")},d=()=>{i.click(),window.popup.renderPopup("success")},u=e=>{i.click(),window.popup.renderPopup("error",e)};e.addEventListener("change",(function(){t.classList.remove("hidden"),document.body.classList.add("modal-open"),window.effects.form.effectSlider.classList.add("hidden"),window.effects.setScaleFactor(),window.effects.resetEffect(),window.validate.clearHashtagValidity(),window.effects.form.effectLevelValue.value="",o.effects.addEventListener("change",window.effects.onEffectsChange),o.hashtags.addEventListener("input",c),document.addEventListener("keydown",s),o.scaleButtons.forEach((e=>{e.addEventListener("click",l)})),n.addEventListener("submit",a)})),i.addEventListener("click",(function(){r()})),i.addEventListener("keydown",(function(e){window.util.onEnterPress(e,r)})),o.submitButton.addEventListener("keydown",(function(e){window.util.onEnterPress(e,r)}))})()})();